/*
CREATE MULTISET TABLE UNICA_TEMP.DE_FAMILY_MEN_STG ,NO FALLBACK ,
     NO BEFORE JOURNAL,
     NO AFTER JOURNAL,
     CHECKSUM = DEFAULT,
     DEFAULT MERGEBLOCKRATIO
     (
      PRIMARY_USER_ID DECIMAL(18,0) NOT NULL,
      DEMO_USER_ID DECIMAL(18,0) NOT NULL,    
      SEGM_ID INTEGER NOT NULL,
	  AUD_ID INTEGER NOT NULL,
      USER_SITE_ID DECIMAL(4,0) NOT NULL,
	  TC VARCHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL,
      COUPON VARCHAR(25) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL,
      COUPON_CODE VARCHAR(25) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL,
      EXP_DT VARCHAR(35) CHARACTER SET LATIN NOT CASESPECIFIC,
      EXCLUDE_REASON_CD SMALLINT)
PRIMARY INDEX ( PRIMARY_USER_ID ,SEGM_ID);
*/
--drop table UNICA_TEMP.DE_FAMILY_MEN_STG
DELETE FROM UNICA_TEMP.DE_FAMILY_MEN_STG ALL
;


INSERT INTO UNICA_TEMP.DE_FAMILY_MEN_STG

SELECT
	PII.PRMRY_USER_ID as PRIMARY_USER_ID,
	PII.DEMO_USER_ID,
	SEG.SEGM_ID,
	AUD.AUD_ID,
	PII.USER_SITE_ID,
	TC,
	COUPON,
	COUPON_CODE,
	TRIM(EXTRACT(DAY FROM END_TS)) || '.' || TRIM(EXTRACT(MONTH FROM END_TS)) || '.' || TRIM(EXTRACT(YEAR FROM END_TS)) AS EXP_DT,
	NULL AS EXCLUDE_REASON_CD
FROM
(

SELECT
stg.USER_ID,
'FAMILY_MEN' as SEGMENT,
TC,
'NO_COUPON'  as COUPON,
'NO_COUPON' as COUPON_CODE,
current_date as END_TS
 FROM p_dbm_input_t.adobe_de_familymen_mam stg
 where 7=7
AND TC='T'	  
		  
UNION 		  

SELECT
stg.USER_ID,
SEGMENT,
TC,
'CONTROL'  as COUPON,
'CONTROL' as COUPON_CODE,
current_date as END_TS
FROM unica_temp.adobe_de_familymen_mam stg
WHERE 7=7
AND TC='C'

UNION  

SELECT
stg.USER_ID,
'FAMILY_MEN' as SEGMENT,
'T' as TC,
'CONTROL'  as COUPON,
'CONTROL' as COUPON_CODE,
current_date as END_TS
FROM PRS_SECURE_V.MDM_USER_PII  stg
WHERE 7=7
AND  user_slctd_id in (
'marekmk', 
'dmalhao@ebay.com',
'psperling@ebay.de',  
'emnewman',
'steffisoleil84')
)  CPN
INNER JOIN PRS_SECURE_V.MDM_USER_PII AS PII on CPN.USER_ID=PII.USER_ID
INNER JOIN	UNICA_TEMP.XMP_AUDIENCE AS AUD
			ON	AUD.AUD_NAME = 'DE_FAMILY_MEN' AND
					77 = AUD.SITE_ID AND
					CURRENT_DATE BETWEEN AUD.START_DATE-10 AND AUD.END_DATE
		
		INNER JOIN	UNICA_TEMP.XMP_SEGMENT AS SEG
			ON	SEG.AUD_ID = AUD.AUD_ID AND
					SEG.SEGM_NAME IN ('FAMILY_MEN') AND
					CURRENT_DATE BETWEEN SEG.START_DATE-10 AND SEG.END_DATE
					;
					
		--	sel * from UNICA_TEMP.DE_FAMILY_MEN_STG;
	/*************************************************************************************************
* STANDARD SUPPRESSIONS, WATERFALL
**************************************************************************************************/

--USER SITE
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  5
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE
							A.DEMO_USER_ID = PII.USER_ID AND
							PII.USER_SITE_ID <> 77 AND
							 user_slctd_id not in (
'mogucan',  --Gybasova, Kristina
'marieck_6',  --Eckert, Thomas
'sraudschus', --Peijan, Stefanie
'emnewman', --Newman, Emma
'mllewiwa', --(Kristin Wyrwa)
'the9280', -- (Theresa Th√ºs)
'sa-32439' , --(Sandy Kim)
'kathihartung832',
'marekmk', 
'dmalhao@ebay.com',
'psperling@ebay.de',  
'steffisoleil84')
						)
;

--NON-CONFIRMED USERS
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  10
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE
							A.DEMO_USER_ID = PII.USER_ID AND
							PII.CNFRMD_YN = 'N'
						)
;

--GXO
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  15
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE 
							A.DEMO_USER_ID = PII.USER_ID AND
							PII.RGSTRD_YN = 'N'
						)
;

--BAD FEEDBACK
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  20
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE 
							A.DEMO_USER_ID = PII.USER_ID AND
							PII.FDBCK_YN = 'N'
						)
;

--CRM_GH FLAG
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  25
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE
							A.DEMO_USER_ID = PII.USER_ID AND
							PII.CRM_GH_YN = 'Y'
						)
;

--B2C
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  30
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE
							A.DEMO_USER_ID = PII.USER_ID AND
							PII.B2C_SLR_YN = 'Y'
						)
;			

--RISK
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  35
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
                        FROM access_views.dw_user_issue PII
						WHERE A.DEMO_USER_ID = PII.USER_ID AND
						scenario_id IN (1, 248, 250, 265, 491, 534, 535, 566, 629)
						AND status_id = 0		
						)
;

--NOT RAMPED  - provided list of 93 users plus one ID
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  40
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM p_dbm_input_t.DE_FAMILY_MEN_NOT_RAMPED2 AS PII
						WHERE
							A.DEMO_USER_ID = PII.USER_ID
													)
;			
			
--RSVP  - list of 1096 users
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  41
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM p_dbm_input_t.DE_FAMILY_MEN_RSVP_EXCL2 AS PII
						WHERE
							A.DEMO_USER_ID = PII.USER_ID
							and PII.user_id not in (
934807981,
1958416172,
1838431930,
1491835652,
1825895226,
866725528,
1284116821,
1556308855
)
													)
;			




--blacklist 29 users
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  43
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE
							A.DEMO_USER_ID = PII.USER_ID
AND PII.user_id  in (
176722949,
107493393,
199175982,
17676934,
845063476,
1229084683,
182212748,
114846791,
1157692775,
35929600,
927684273,
104517236,
1187848288,
165374832,
175863163,
51655605,
1057854418,
69588776,
178073211,
88617290,
287673190,
36413308,
696782356,
1115585042,
431019864,
67388821,
129084172,
118365892,
613669529
)  -- 29 users from blacklist
);


--UNKNOWN - list of 1502 users
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  42
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM p_dbm_input_t.DE_FAMILY_MEN_UNK_EXCL2 AS PII
						WHERE
							A.DEMO_USER_ID = PII.USER_ID
													)
;			

--CANCEL eBay Plus
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  44
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
SELECT *
FROM Access_Views.EBYPLS_BUYER_SBSCRPTN_HIST hist
INNER JOIN P_DBM_INPUT_T.adobe_de_familymen_mam fm
ON hist.buyer_id = fm.user_id
WHERE A.DEMO_USER_ID = hist.buyer_id
AND hist.ebypls_buyer_status_cd in ( -1,1)
AND CURRENT_DATE - 2 BETWEEN hist.buyer_status_start_dt AND hist.buyer_status_end_dt
AND fm.tc = 'T'
);

--not in product list 
--CANCEL eBay Plus
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  45
WHERE 	EXCLUDE_REASON_CD IS NULL
AND TC='T'
and demo_user_id not in (
934807981,
1958416172,
1838431930,
1491835652,
1825895226,
866725528,
1284116821,
1556308855
)
AND 			NOT EXISTS	(
SELECT *
FROM P_DBM_INPUT_T.FM_NO_UPGRADE hist

WHERE A.DEMO_USER_ID = hist.user_id
);

--list from product
UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  46
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE
							A.DEMO_USER_ID = PII.USER_ID
AND PII.user_id  in (
2736311,
17186694,
17294455,
17474492,
17508327,
17513377,
17568688,
17620868,
17672178,
17736108,
17768249,
17777026,
17781633,
18130417,
18176321,
18468441,
19574450,
21296144,
22449304,
22993070,
24257021,
24373824,
24598698,
24808363,
24890804,
25391827,
25885088,
25985708,
26277315,
27727207,
28158414,
28913144,
29237582,
33272794,
33771574,
35297195,
35425280,
35428376,
37016064,
37851654,
38382436,
40926977,
41543734,
41948328,
41991835,
42444750,
42786814,
43034837,
43195479,
43336633,
44118945,
44560264,
44644884,
45138569,
46039198,
46149865,
46693043,
47010877,
48410439,
48437589,
48978759,
49170622,
51024253,
51925788,
52159003,
53501339,
53560540,
54084198,
57289970,
57447218,
58361981,
58572218,
58871419,
59222851,
59233223,
59381251,
60473454,
60992151,
62270930,
63055255,
64292498,
65070974,
66529897,
66666649,
68133497,
69479013,
71548554,
71677188,
72588904,
72929948,
73131628,
74868353,
74958631,
74980294,
77934084,
78658493,
79647725,
79723948,
79989860,
81922668,
82635106,
83343630,
84237594,
84870402,
85351763,
87364414,
90868759,
90994488,
91342316,
93149760,
97953512,
98112964,
99898543,
100373693,
100541612,
100892762,
100934135,
101289263,
101898953,
101925406,
102106285,
103075741,
103893712,
104926570,
105245582,
105611515,
107918953,
112513191,
117265671,
118276552,
120182460,
120551570,
125168848,
127896859,
129145385,
130050665,
130226121,
132569458,
132681147,
133815559,
138571306,
141753224,
142742882,
144631553,
146481423,
146789836,
147563655,
147622882,
149308843,
163978466,
169112763,
174088259,
175230862,
178073342,
184496918,
187223377,
191483303,
197049212,
197646203,
199809493,
204514692,
205501341,
210010779,
214097381,
215583730,
216943924,
217838256,
278397259,
284485526,
334094446,
334348117,
355733808,
359339245,
396410203,
400823821,
402045007,
411732638,
458620294,
472988246,
537419450,
557243356,
564847431,
591247824,
594050589,
629744516,
660589928,
665442300,
669547222,
680974267,
684137766,
717341734,
754331883,
799425748,
836490517,
843785303,
869730515,
874407025,
880344632,
890124947,
924038304,
982161134,
989039799,
994516832,
1003140782,
1004174683,
1007725214,
1023410488,
1024822151,
1039395675,
1045068853,
1049038503,
1050668709,
1062737164,
1085540615,
1094496889,
1095846850,
1106516385,
1134698626,
1137957642,
1139342187,
1162791507,
1163939296,
1165425543,
1174597835,
1184589375,
1194799823,
1197200435,
1218286922,
1220839549,
1222949354,
1225156051,
1237380716,
1258340659,
1266534684,
1268546299,
1268952452,
1322479914,
1392309381,
1490569993,
1757282028,
720810254,
62324338,
846945985,
38382436,
187530130,
165257546,
1106516385,
58361981,
46149865,
355733808,
69479013,
59222851,
33771574,
17768249,
48410439,
43034837,
1303920823,
175230862,
51024253,
44644884,
163978466,
17568688,
105245582,
79723948,
52159003,
1106516385,
58361981,
46149865,
355733808,
69479013,
59222851,
33771574,
17768249,
48410439,
3034837,
175230862,
51024253,
44644884,
52159003,
149308843,
43195479,
167581808,
29029336,
52159003,
51734729,
146481423,
65070974,
26979016,
40926977,
42786814

)  -- provided by product team
);


--CPN CONTROL
/*UPDATE A 
FROM UNICA_TEMP.DE_FAMILY_MEN_STG AS A
SET EXCLUDE_REASON_CD =  45
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM P_MDS_T.DE_SpendStretch_Dec_DBM AS PII
						WHERE
							A.PRIMARY_USER_ID = PII.PRIMARY_USER_ID
							AND segment= 'CONTROL'
													)
;		*/	


								
drop table UNICA_TEMP.DE_FAMILY_MEN_DAILY;
CREATE MULTISET TABLE UNICA_TEMP.DE_FAMILY_MEN_DAILY as (
SELECT 
STG.PRIMARY_USER_ID,
STG.DEMO_USER_ID,    
STG.AUD_ID,
STG.SEGM_ID,
STG.TC,
STG.COUPON,
STG.COUPON_CODE,
STG.EXP_DT,
case when RWRD.user_id is null then 'N' else 'Y' end AS EBAY_PLUS,
RWRD.POINTS_CONFIRMED as POINTS_CONFIRMED,
RWRD.REWARDS_DATE as REWARDS_DATE,
case when MICRO.MICRO_CL_NAME is not null then  MICRO.MICRO_CL_NAME
else 'OTHERS' end as MICROSEGMENT
FROM UNICA_TEMP.DE_FAMILY_MEN_STG STG
LEFT JOIN (SELECT							A.USER_ID
											,SUM(OVRAL_POINTS_NUM) OVRAL_POINTS_NUM
											,SUM(CASE WHEN POINTS_CNFRMD_NUM <>0 THEN POINTS_CNFRMD_NUM ELSE 0 END) AS POINTS_CONFIRMED
											,SUM(CASE WHEN POINTS_PNDG_NUM <>0 THEN POINTS_PNDG_NUM ELSE 0 END) AS POINTS_PENDING
											,current_date-1 as REWARDS_DATE
						FROM								PRS_RESTRICTED_V.PLUS_RWRD_MBR A
						INNER JOIN								( SELECT				distinct BUYER_ID
																						,EBYPLS_BUYER_STATUS_CD
																						FROM access_views.EBYPLS_BUYER_SBSCRPTN_HIST 
																						WHERE SITE_ID = 77
																						and EBYPLS_BUYER_STATUS_CD in (0,1)
																						and current_date-2 between BUYER_STATUS_START_DT and BUYER_STATUS_END_DT
																						) PLUS
						ON										A.USER_ID = PLUS.BUYER_ID
						LEFT JOIN					(SELECT  USER_ID, EVENT_DTL_ID, OVRAL_POINTS_NUM, POINTS_CNFRMD_NUM,POINTS_PNDG_NUM

FROM ( SELECT  USER_ID, EVENT_DTL_ID, OVRAL_POINTS_NUM, POINTS_CNFRMD_NUM,POINTS_PNDG_NUM

   ,(ROW_NUMBER() over (partition by blnc_id,event_dtl_id,EVENT_TYPE_TXT order by trans_upd_ts desc)) AS alias_6798

 FROM  PRS_RESTRICTED_V.PLUS_RWRD_POINTS_BLNC_HIST

 WHERE 7=7--USER_ID = 1958416172 --AND EVENT_DTL_ID = 5014449498   -- this is sample user and etl id.

  ) A   WHERE A.alias_6798 = 1 ) B
						ON										A.USER_ID = B.USER_ID
						WHERE							STATUS = 1
						AND									CURRENT_DATE BETWEEN A.STATUS_START_DT AND A.STATUS_END_DT
						GROUP BY						1 ) RWRD
ON STG.demo_user_id=RWRD.user_id
LEFT JOIN  (select user_id , MICRO_CL_NAME ,
RANK() OVER (PARTITION BY user_id  ORDER  BY user_id,user_cl_order  ASC ) AS ITEM_ORDER
from PRS_RESTRICTED_V.MICRO_CLSTR_USER_SGMNT MICRO
where 7=7 and MICRO.SITE_ID=77
and data_dt = (select max(data_dt) from  PRS_RESTRICTED_V.MICRO_CLSTR_USER_SGMNT where SITE_ID=77)
and MICRO_CL_ID IN (15,1,10,17)
QUALIFY ITEM_ORDER = 1) MICRO
ON  STG.demo_user_id=MICRO.user_id 
WHERE 	STG.EXCLUDE_REASON_CD IS NULL

) WITH DATA;
/*************************************************************************************************
MESSAGE LEVEL - START WITH HERO MESSAGES
Taking data from Audience, populating message staging table
***************************************************************************************************/

DELETE FROM UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG ALL
;

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM001_MAIN'	
;
 -- exclude module 2/3 for Xmas sendout
INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM002_REW_NO'	
	WHERE (current_date<= CAST('10/11/2019' as date FORMAT 'MM/DD/YYYY')	OR 		EBAY_PLUS='N'	)
;

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM003_REW_YES_BELOW200'	
	WHERE 7=7
	AND current_date> CAST('10/11/2019' as date FORMAT 'MM/DD/YYYY')	
	AND ebay_plus='Y'
	AND NVL(POINTS_CONFIRMED,0)<200
;

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM004_REW_YES_ABOVE200'	
	WHERE 7=7
	AND current_date> CAST('10/11/2019' as date FORMAT 'MM/DD/YYYY')	
	AND ebay_plus='Y'
	AND NVL(POINTS_CONFIRMED,0)>=200
;
	
	/*
	INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM017_SPEND_STRETCH_GENERIC'	
	WHERE 7=7
	and TC='T'
	AND COUPON='ACTIVE Generic'
	AND COUPON_CODE = 'MEINRABATT10';
	
		INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM018_SPEND_STRETCH_PA'	
	WHERE 7=7
	and TC='T'
	AND COUPON='ACTIVE EM PnA'
	AND COUPON_CODE = 'MEINRABATT10';
	
		INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM019_SPEND_STRETCH_HG'	
	WHERE 7=7
	and TC='T'
	AND COUPON='ACTIVE EM HnG'
	AND COUPON_CODE = 'MEINRABATT10';
*/

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM006_INVENTORY_PLUS'	
	WHERE 7=7
	AND current_date> CAST('11/01/2019' as date FORMAT 'MM/DD/YYYY')	
	--OR	(current_date> CAST('11/01/2019' as date FORMAT 'MM/DD/YYYY')	
	--AND  EXTRACT(DAY FROM current_date) MOD 2 =1)
	
	
;

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM007_INVENTORY_EVERYDAY'	
	WHERE 7=7
	AND current_date<CAST('11/01/2019' as date FORMAT 'MM/DD/YYYY')	
	--AND  EXTRACT(DAY FROM current_date) MOD 2 =0
;
/*
INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM008_MICRO_CAR_PARTS'	
	WHERE 7=7
	AND MICROSEGMENT = 'Car & Motorbike parts'
;

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM009_MICRO_HOME_GARDEN'	
	WHERE 7=7
	AND MICROSEGMENT = 'Home Improver & Garden'
;

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM010_MICRO_ELECTRONICS'	
	WHERE 7=7
	AND MICROSEGMENT = 'Consumer Electronics & Mobile'
;

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD 
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN  UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM013_MICRO_KIDS'	
	WHERE 7=7
	AND MICROSEGMENT = 'Kids & Babies'
;

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN  UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM011_MIRO_FALLBACK'	
	WHERE 7=7
	AND MICROSEGMENT = 'OTHERS'
;
*/

INSERT INTO UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
SELECT
      AUD.PRIMARY_USER_ID,
      AUD.DEMO_USER_ID,    
	AUD.AUD_ID,
	AUD.SEGM_ID,
	MSG.MSG_ID,
	NULL as JOURNEY_ID,
	NULL as SEQUENCE,	
	MSG.PRIORITY,
	NULL AS EXCL_GRP_ID,
	NULL AS EM_CHANNEL,
	NULL AS MC_CHANNEL,
	NULL AS OM_CHANNEL,
	NULL AS PN_CHANNEL,
	NULL AS HERO_MESSAGE_YN,
	NULL AS MESSAGE2_YN,
	NULL AS MESSAGE3_YN,
	NULL AS MESSAGE4_YN,
	NULL AS MESSAGE5_YN,
	NULL AS MESSAGE6_YN,
	NULL AS EXCLUDE_REASON_CD,
	CAST (CURRENT_DATE AS DATE FORMAT 'YYYY-MM-DD') AS DATA_DATE
FROM
	UNICA_TEMP.DE_FAMILY_MEN_DAILY AS AUD
	
		INNER JOIN UNICA_TEMP.XMP_MAP_SEGMENT_MESSAGE AS MAP_SM
			ON	AUD.SEGM_ID = MAP_SM.SEGM_ID AND
					CURRENT_DATE BETWEEN MAP_SM.START_DATE-10 AND MAP_SM.END_DATE
					
		INNER JOIN UNICA_TEMP.XMP_MESSAGE AS MSG
			ON	MSG.MSG_ID = MAP_SM.MSG_ID AND
					CURRENT_DATE BETWEEN MSG.START_DATE-10 AND MSG.END_DATE AND
					MSG.MSG_NAME = 'DE_FM012_EBAY_PLUS'	
	WHERE 7=7
;

UPDATE	UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
FROM 	UNICA_TEMP.DE_FM_MESSAGE_PLACEMENT AS PLAC
SET
	HERO_MESSAGE_YN = PLAC.HERO_MESSAGE_YN,
	MESSAGE2_YN = PLAC.MESSAGE2_YN,
	MESSAGE3_YN = PLAC.MESSAGE3_YN,
	MESSAGE4_YN = PLAC.MESSAGE4_YN,
	MESSAGE5_YN = PLAC.MESSAGE5_YN,
	MESSAGE6_YN = PLAC.MESSAGE6_YN
WHERE UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG.MSG_ID = PLAC.MSG_ID
;

/*UPDATE CHANNELS*/
UPDATE	UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
FROM		UNICA_TEMP.XMP_MESSAGE_CHANNEL AS CHNL
SET
	EM_CHANNEL = CHNL.EM_CHANNEL,
	MC_CHANNEL = CHNL.MC_CHANNEL,
	OM_CHANNEL = CHNL.OM_CHANNEL,
	PN_CHANNEL = CHNL.PN_CHANNEL
WHERE UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG.MSG_ID = CHNL.MSG_ID
;
/*EXCLUDE USERS WHO DON'T HAVE ENOUGH MESSAGES*/
UPDATE	UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
FROM		(
				SELECT PRIMARY_USER_ID,AUD_ID,SEGM_ID, COUNT(*) AS USR_CNT
				FROM UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG
				GROUP BY 1,2,3
				HAVING USR_CNT < 3
				) AS EXC
SET	EXCLUDE_REASON_CD = 44
WHERE
	UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG.PRIMARY_USER_ID = EXC.PRIMARY_USER_ID AND
	UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG.AUD_ID = EXC.AUD_ID AND
	UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG.SEGM_ID = EXC.SEGM_ID 
;
--sel * from UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG

 /*************************************************************************************************
INSERTING INTO EMAIL STAGING TABLE
***************************************************************************************************/
	
DELETE FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG ALL;
 
 INSERT INTO UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG
 SELECT
	STG.PRIMARY_USER_ID,
	STG.DEMO_USER_ID,
	STG.AUD_ID,
	STG.SEGM_ID,
	STG.JOURNEY_ID AS JOURNEY_ID,
	STG.SEQUENCE AS SEQUENCE,
	STG.MSG_ID AS HERO_MESSAGE,
	NULL AS MESSAGE2,
	NULL AS MESSAGE3,
	NULL AS MESSAGE4,
	NULL AS MESSAGE5,
	NULL AS MESSAGE6,
	NULL AS EXCLUDE_REASON_CD,
	NVL(POINTS_CONFIRMED,0)  as PLUS_POINTS,
	REWARDS_DATE as REWARDS_DATE,
	'N' as CH_MC_YN,
	STG.DATA_DATE	
FROM
	UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG STG
	JOIN  UNICA_TEMP.DE_FAMILY_MEN_DAILY DAILY on STG.DEMO_USER_ID=DAILY.DEMO_USER_ID
WHERE
	EXCLUDE_REASON_CD IS NULL AND
	HERO_MESSAGE_YN = 'Y'
GROUP BY
	STG.PRIMARY_USER_ID,
	STG.DEMO_USER_ID,
	STG.AUD_ID,
	STG.SEGM_ID,
	STG.JOURNEY_ID,
	STG.SEQUENCE,
	STG.MSG_ID,
	POINTS_CONFIRMED,
	REWARDS_DATE,
	STG.DATA_DATE
;	

UPDATE UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG
FROM UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG AS B
 SET 
	MESSAGE2=B.MSG_ID
WHERE
	UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG.PRIMARY_USER_ID = B.PRIMARY_USER_ID AND
	B.MESSAGE2_YN = 'Y' AND
	B.EXCLUDE_REASON_CD IS NULL
;

UPDATE UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG
FROM UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG AS B
 SET 
	MESSAGE3=B.MSG_ID
WHERE
	UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG.PRIMARY_USER_ID = B.PRIMARY_USER_ID AND
	B.MESSAGE3_YN = 'Y'
;

UPDATE UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG
FROM UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG AS B
 SET 
	MESSAGE4=B.MSG_ID
WHERE
	UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG.PRIMARY_USER_ID = B.PRIMARY_USER_ID AND
	B.MESSAGE4_YN = 'Y'
;

UPDATE UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG
FROM UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG AS B
 SET 
	MESSAGE5=B.MSG_ID
WHERE
	UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG.PRIMARY_USER_ID = B.PRIMARY_USER_ID AND
	B.MESSAGE5_YN = 'Y'
;

UPDATE UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG
FROM UNICA_TEMP.DE_FM_MESSAGE_DAILY_STG AS B
 SET 
	MESSAGE6=B.MSG_ID
WHERE
	UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG.PRIMARY_USER_ID = B.PRIMARY_USER_ID AND
	B.MESSAGE6_YN = 'Y'
;




--MC FLAG
UPDATE A FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS A
SET
	CH_MC_YN =  'Y'
	
WHERE 	CH_MC_YN =  'N' AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE (PII.MSGCENTER_PROMOSOFFERSEVENTS = 'Y'   
						or user_slctd_id  in (
'mogucan',  --Gybasova, Kristina
'marieck_6',  --Eckert, Thomas
'sraudschus', --Peijan, Stefanie
'emnewman', --Newman, Emma
'mllewiwa', --(Kristin Wyrwa)
'the9280', -- (Theresa Th√ºs)
'sa-32439' , --(Sandy Kim)
'kathihartung832',
'marekmk', 
'dmalhao@ebay.com',
'psperling@ebay.de',  
'steffisoleil84'))
						AND A.DEMO_USER_ID = PII.USER_ID
						)
;

--NON-RESPONDER FLAG
UPDATE A FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS A
SET
	EXCLUDE_REASON_CD =  45
	
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE PII.RSPNDR_YN = 'N' AND A.DEMO_USER_ID = PII.USER_ID
						)
;
						
--BLACKLIST FLAG
UPDATE A FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS A
SET
	EXCLUDE_REASON_CD =  50
	
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE PII.BLCKLST_YN = 'Y' AND A.DEMO_USER_ID = PII.USER_ID
						)
;
						
--UNDELIVERABLE FLAG
UPDATE A FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS A
SET
	EXCLUDE_REASON_CD =  55
	
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE PII.DLVRABLE_YN = 'N' AND A.DEMO_USER_ID = PII.USER_ID
						and user_slctd_id not in (
'mogucan',  --Gybasova, Kristina
'marieck_6',  --Eckert, Thomas
'sraudschus', --Peijan, Stefanie
'emnewman', --Newman, Emma
'mllewiwa', --(Kristin Wyrwa)
'the9280', -- (Theresa Th√ºs)
'sa-32439' , --(Sandy Kim)
'kathihartung832',
'marekmk', 
'dmalhao@ebay.com',
'psperling@ebay.de',  
'steffisoleil84')
						)
;

--ACTIVITY FLAG
UPDATE A FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS A
SET
	EXCLUDE_REASON_CD =  60
	
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE PII.ACTV_YN = 'N' AND A.DEMO_USER_ID = PII.USER_ID
						)
;
						
--EMAIL MASTER PREFERENCE FLAG
UPDATE A FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS A
SET
	EXCLUDE_REASON_CD =  65
	
WHERE 	EXCLUDE_REASON_CD IS NULL AND
			EXISTS	(
						SELECT *
						FROM PRS_SECURE_V.MDM_USER_PII AS PII
						WHERE PII.EMAIL_MAST_PREF_YN = 'N' AND A.DEMO_USER_ID = PII.USER_ID 
						AND user_slctd_id not in (
'mogucan',  --Gybasova, Kristina
'marieck_6',  --Eckert, Thomas
'sraudschus', --Peijan, Stefanie
'emnewman', --Newman, Emma
'mllewiwa', --(Kristin Wyrwa)
'the9280', -- (Theresa Th√ºs)
'sa-32439' , --(Sandy Kim)
'kathihartung832',
'marekmk', 
'dmalhao@ebay.com',
'psperling@ebay.de',  
'steffisoleil84')
						);

						


-- AUDIENCE CONTROL GROUP
UPDATE UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS A
SET 
	EXCLUDE_REASON_CD = 99
WHERE
	EXCLUDE_REASON_CD IS NULL AND
	EXISTS	(
						SELECT *
						FROM UNICA_TEMP.DE_FAMILY_MEN_DAILY AS PII
						WHERE PII.TC = 'C' AND A.DEMO_USER_ID = PII.DEMO_USER_ID 
						);
					
						
--sel * from UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG;						


/* PREPARING DATA FOR  SENDOUT - 27. & 31.12. 

DELETE FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_MC ALL;

INSERT INTO UNICA_TEMP.DE_FM_TARGETING_DAILY_MC
--create multiset table UNICA_TEMP.DE_FM_TARGETING_DAILY_MC as (
SELECT
	STG.PRIMARY_USER_ID,
	STG.DEMO_USER_ID,
	STG.AUD_ID,
	AUD.AUD_NAME,
	STG.SEGM_ID,
	SEGM.SEGM_ABR AS SEGM_NAME,
	STG.JOURNEY_ID,
	STG.SEQUENCE,
	STG.HERO_MESSAGE,
	NVL(STG.MESSAGE2,0) MESSAGE2,
	NVL(STG.MESSAGE3,0) MESSAGE3,
	STG.MESSAGE4,
	NVL(STG.MESSAGE5,0)  MESSAGE5,
	STG.MESSAGE6,
	DFMD.TC,
	CH_MC_YN,
	case when EXCLUDE_REASON_CD IS NULL OR EXCLUDE_REASON_CD=99 THEN 'Y' else 'N' end as CH_EM_YN,	
	STG.DATA_DATE,
	STG.PLUS_POINTS,
	STG.REWARDS_DATE

FROM
	UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS STG
		JOIN UNICA_TEMP.DE_FAMILY_MEN_DAILY AS DFMD
						ON  STG.DEMO_USER_ID = DFMD.DEMO_USER_ID
		INNER JOIN  UNICA_TEMP.XMP_AUDIENCE AS AUD
			ON 	STG.AUD_ID = AUD.AUD_ID AND
					CURRENT_DATE BETWEEN AUD.START_DATE-10 AND AUD.END_DATE
		
		INNER JOIN  UNICA_TEMP.XMP_SEGMENT AS SEGM
			ON 	STG.SEGM_ID = SEGM.SEGM_ID AND
					CURRENT_DATE BETWEEN SEGM.START_DATE-10 AND SEGM.END_DATE
		
		INNER JOIN PRS_SECURE_V.MDM_USER_PII AS PII
			ON STG.DEMO_USER_ID = PII.USER_ID

WHERE
	7=7
	/*AND PII.user_slctd_id in (
'mogucan',  --Gybasova, Kristina
'marieck_6',  --Eckert, Thomas
'sraudschus', --Peijan, Stefanie
'dmalhao', --Malhao, Diogo
'marekmk', --Marek Mrazik
'emnewman', --Newman, Emma
'mllewiwa', --(Kristin Wyrwa)
'the9280', -- (Theresa Th√ºs)
'sa-32439' , --(Sandy Kim)
'kathihartung832')   --(Kathleen Hoffmann)
*/
;


--DELETE FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_MC_20191231 ALL;

--INSERT INTO UNICA_TEMP.DE_FM_TARGETING_DAILY_MC_20191231
create multiset table UNICA_TEMP.DE_FM_TARGETING_DAILY_MC_2020 as (
SELECT
	STG.PRIMARY_USER_ID,
	STG.DEMO_USER_ID,
	STG.AUD_ID,
	AUD.AUD_NAME,
	STG.SEGM_ID,
	SEGM.SEGM_ABR AS SEGM_NAME,
	STG.JOURNEY_ID,
	STG.SEQUENCE,
	STG.HERO_MESSAGE,
	0 MESSAGE2,
	0 MESSAGE3,
	0 MESSAGE4,
	0 MESSAGE5,
	STG.MESSAGE6,
	DFMD.TC,
	CH_MC_YN,
	case when EXCLUDE_REASON_CD IS NULL OR EXCLUDE_REASON_CD=99 THEN 'Y' else 'N' end as CH_EM_YN,	
	STG.DATA_DATE,
	STG.PLUS_POINTS,
	STG.REWARDS_DATE

FROM
	UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS STG
		JOIN UNICA_TEMP.DE_FAMILY_MEN_DAILY AS DFMD
						ON  STG.DEMO_USER_ID = DFMD.DEMO_USER_ID
		INNER JOIN  UNICA_TEMP.XMP_AUDIENCE AS AUD
			ON 	STG.AUD_ID = AUD.AUD_ID AND
					CURRENT_DATE BETWEEN AUD.START_DATE-10 AND AUD.END_DATE
		
		INNER JOIN  UNICA_TEMP.XMP_SEGMENT AS SEGM
			ON 	STG.SEGM_ID = SEGM.SEGM_ID AND
					CURRENT_DATE BETWEEN SEGM.START_DATE-10 AND SEGM.END_DATE
		
		INNER JOIN PRS_SECURE_V.MDM_USER_PII AS PII
			ON STG.DEMO_USER_ID = PII.USER_ID

WHERE
7=7
) with data
;  

create multiset table UNICA_TEMP.DE_FM_TARGETING_DAILY_MC_2020_POINTS as (
SELECT
	STG.PRIMARY_USER_ID,
	STG.DEMO_USER_ID,
	STG.AUD_ID,
	AUD.AUD_NAME,
	STG.SEGM_ID,
	SEGM.SEGM_ABR AS SEGM_NAME,
	STG.JOURNEY_ID,
	STG.SEQUENCE,
	STG.HERO_MESSAGE,
	STG.MESSAGE2,
	0 MESSAGE3,
	0 MESSAGE4,
	0 MESSAGE5,
	STG.MESSAGE6,
	DFMD.TC,
	CH_MC_YN,
	case when EXCLUDE_REASON_CD IS NULL OR EXCLUDE_REASON_CD=99 THEN 'Y' else 'N' end as CH_EM_YN,	
	STG.DATA_DATE,
	STG.PLUS_POINTS,
	STG.REWARDS_DATE

FROM
	UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS STG
		JOIN UNICA_TEMP.DE_FAMILY_MEN_DAILY AS DFMD
						ON  STG.DEMO_USER_ID = DFMD.DEMO_USER_ID
		INNER JOIN  UNICA_TEMP.XMP_AUDIENCE AS AUD
			ON 	STG.AUD_ID = AUD.AUD_ID AND
					CURRENT_DATE BETWEEN AUD.START_DATE-10 AND AUD.END_DATE
		
		INNER JOIN  UNICA_TEMP.XMP_SEGMENT AS SEGM
			ON 	STG.SEGM_ID = SEGM.SEGM_ID AND
					CURRENT_DATE BETWEEN SEGM.START_DATE-10 AND SEGM.END_DATE
		
		INNER JOIN PRS_SECURE_V.MDM_USER_PII AS PII
			ON STG.DEMO_USER_ID = PII.USER_ID

WHERE
7=7
AND PLUS_POINTS>=200
) with data
;  
/* PREPARING DATA FOR EMAIL SENDOUT */

/*
DELETE FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_EM ALL;

INSERT INTO UNICA_TEMP.DE_FM_TARGETING_DAILY_EM
SELECT
	STG.PRIMARY_USER_ID,
	STG.DEMO_USER_ID,
	STG.AUD_ID,
	AUD.AUD_NAME,
	STG.SEGM_ID,
	SEGM.SEGM_ABR AS SEGM_NAME,
	STG.JOURNEY_ID,
	STG.SEQUENCE,
	STG.HERO_MESSAGE,
	STG.MESSAGE2,
	STG.MESSAGE3,
	STG.MESSAGE4,
	STG.MESSAGE5,
	STG.MESSAGE6,
	PLUS_POINTS,
	REWARDS_DATE,
	CASE
		WHEN EXCLUDE_REASON_CD IS NULL THEN 'T'
		WHEN EXCLUDE_REASON_CD = 99 THEN 'C'
	END AS TC,
	STG.DATA_DATE
FROM
	UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG AS STG
		INNER JOIN  UNICA_TEMP.XMP_AUDIENCE AS AUD
			ON 	STG.AUD_ID = AUD.AUD_ID AND
					CURRENT_DATE BETWEEN AUD.START_DATE-10 AND AUD.END_DATE
		INNER JOIN  UNICA_TEMP.XMP_SEGMENT AS SEGM
			ON 	STG.SEGM_ID = SEGM.SEGM_ID AND
					CURRENT_DATE BETWEEN SEGM.START_DATE-10 AND SEGM.END_DATE	
		INNER JOIN PRS_SECURE_V.MDM_USER_PII AS PII
			ON STG.DEMO_USER_ID = PII.USER_ID
WHERE
	EXCLUDE_REASON_CD IS NULL 
	OR EXCLUDE_REASON_CD = 99
;
*/
/* PREPARING DATA FOR DMP */
DELETE FROM UNICA_TEMP.DE_FM_TARGETING_DMP_NOPLUS_STG ALL;

INSERT INTO  UNICA_TEMP.DE_FM_TARGETING_DMP_NOPLUS_STG  
select  demo_user_id as user_id from UNICA_TEMP.DE_FAMILY_MEN_DAILY where TC='T'  --and ebay_plus= 'N'

;

/* PREPARING DATA FOR PN */
DELETE FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_PN_STG ALL;

INSERT INTO  UNICA_TEMP.DE_FM_TARGETING_DAILY_PN_STG 
select  demo_user_id as user_id from UNICA_TEMP.DE_FAMILY_MEN_DAILY where TC='T'
;

--EM archiv
INSERT INTO  UNICA_TEMP.DE_FM_TARGETING_EM_ARCHIV 
SELECT 
PRIMARY_USER_ID,
DEMO_USER_ID,
AUD_ID,
AUD_NAME,
SEGM_ID,
SEGM_NAME,
JOURNEY_ID,
SEQUENCE,
HERO_MESSAGE,
MESSAGE2,
MESSAGE3,
MESSAGE4,
MESSAGE5,
MESSAGE6,
PLUS_POINTS,
REWARDS_DATE,
TC,
DATA_DATE
from UNICA_TEMP.DE_FM_TARGETING_DAILY_MC
where ch_em_yn='Y'
;

--ALL archiv




/*  QA counts, insert results here https://docs.google.com/spreadsheets/d/1gvnzJB0cmCe7jxrB1d81JJ3PufgfVwh54tDoVFcdwFk/edit#gid=2014116307
--EM
SELECT TC, HERO_MESSAGE,
	MESSAGE2,
	MESSAGE3,
	MESSAGE4,
	MESSAGE5,
	MESSAGE6,
	count(demo_user_id) 
	FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_MC_2020_POINTS
	where CH_EM_YN='Y'
	and TC='T'
	group by 1,2,3,4,5,6,7;
	
--MC	
SELECT TC, HERO_MESSAGE,
	MESSAGE2,
	MESSAGE3,
	MESSAGE4,
	MESSAGE5,
	MESSAGE6,
	count(demo_user_id) 
	FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_MC_2020_POINTS
	where CH_MC_YN='Y'
	and TC='T'
	group by 1,2,3,4,5,6,7;
	
	--ALL
	SELECT TC, HERO_MESSAGE,
	MESSAGE2,
	MESSAGE3,
	MESSAGE4,
	MESSAGE5,
	MESSAGE6,
	count(demo_user_id) 
	FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_MC_2020_POINTS
	--where CH_EM_YN='Y'
	--and TC='T'
	group by 1,2,3,4,5,6,7;
	
	--suppression 
	select exclude_reason_cd, count(demo_user_id) from UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG  group by 1;
	select exclude_reason_cd, count(demo_user_id) from UNICA_TEMP.DE_FAMILY_MEN_STG  group by 1;
	
	
	SELECT 
	MESSAGE2,
	count(STG.demo_user_id) ALL_users,
	count(case when CH_MC_YN='Y' then STG.demo_user_id end ) MC,
	count(case when  EXCLUDE_REASON_CD IS NULL OR EXCLUDE_REASON_CD=99 then STG.demo_user_id end ) EMAIL, MIN(PLUS_POINTS), MAX(PLUS_POINTS)
	FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_EM_STG STG
	JOIN UNICA_TEMP.DE_FAMILY_MEN_DAILY AS DFMD
						ON  STG.DEMO_USER_ID = DFMD.DEMO_USER_ID
	where 7=7
	and TC='T'
	group by 1;
	
	SELECT 
	MESSAGE5,
	count(demo_user_id) ALL_users,
	count(case when CH_MC_YN='Y' then demo_user_id end ) MC,
	count(case when CH_EM_YN='Y' then demo_user_id end ) EMAIL
	FROM UNICA_TEMP.DE_FM_TARGETING_DAILY_MC
	where 7=7
	and TC='T'
	group by 1;
	
	--PN
	SELECT count(distinct u.user_id)
FROM 
ACCESS_VIEWS.USER_MSG_SBSCRBR_DTL sbt 

JOIN ACCESS_VIEWS.USER_MSG_EVENT_SBSCRBR_DTL esbt ON sbt.msg_sbscrbr_id = esbt.msg_sbscrbr_id
JOIN ACCESS_VIEWS.dw_users u ON sbt.sbscrbr_id = u.USER_SLCTD_ID 
join UNICA_TEMP.DE_FM_TARGETING_DAILY_PN_STG a on u.user_id=a.user_id
WHERE 7=7
AND sbt.SBSCRBR_STATE_CD =0 -- enabled=0, disabled=1, suspended=2
AND esbt.msg_event_state_cd = 0 --active
AND esbt.msg_event_group_id=5000000732  --Events and Offers Subscription event - AdhocMarketingCampaign
AND sbt.app_id=1000101 --Android
AND USER_CNTRY_ID = 77 --Android 
AND NOT EXISTS (   SELECT user_id 
      FROM Prs_restricted_v.mh_ntfctn_opt_user AS opt
      WHERE opt.user_id = a.user_id) --additional condition opt-out
	  
	  */
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
